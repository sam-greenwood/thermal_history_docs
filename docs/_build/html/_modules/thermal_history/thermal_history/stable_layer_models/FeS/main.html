

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>thermal_history.thermal_history.stable_layer_models.FeS.main &mdash; thermal_history  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> thermal_history
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../simple_example.html">Running a simple example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Advanced.html">Adding new methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../API_index.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">thermal_history</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
      <li>thermal_history.thermal_history.stable_layer_models.FeS.main</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for thermal_history.thermal_history.stable_layer_models.FeS.main</h1><div class="highlight"><pre>
<span></span><span class="c1">#Short description for use with thermal_history.utils.available_models()</span>
<span class="n">Description</span> <span class="o">=</span> <span class="s1">&#39;Thermal stratification with embedded FeS layer for Mercury. This is under development!&#39;</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">bisect</span>
<span class="kn">from</span> <span class="nn">thermal_history.utils.optimised_funcs</span> <span class="kn">import</span> <span class="n">trapezoid</span><span class="p">,</span> <span class="n">linspace</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">thermal_history</span> <span class="k">as</span> <span class="nn">th</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">leeds_thermal</span>

<span class="kn">from</span> <span class="nn">...core_models.leeds.routines</span> <span class="kn">import</span> <span class="n">profiles</span> <span class="k">as</span> <span class="n">prof</span>
<span class="kn">from</span> <span class="nn">..leeds_thermal.routines</span> <span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">func</span>
<span class="kn">from</span> <span class="nn">.routines.diffusion</span> <span class="kn">import</span> <span class="n">diffusion_uneven</span><span class="p">,</span> <span class="n">diffusion_discont</span>

<span class="c1">#Define main functions based on leeds_thermal</span>
<span class="c1"># evolve = leeds_thermal.evolve</span>
<span class="n">update</span> <span class="o">=</span> <span class="n">leeds_thermal</span><span class="o">.</span><span class="n">update</span>
<span class="n">progress</span> <span class="o">=</span> <span class="n">leeds_thermal</span><span class="o">.</span><span class="n">progress</span>

<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>

    <span class="n">sl</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">stable_layer</span>
    <span class="n">prm</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span>
    <span class="c1">#Force initial stable layer to FeS layer size, then call leeds_thermal setup</span>
    <span class="n">prm</span><span class="o">.</span><span class="n">layer_thickness</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">FeS_size</span>
    <span class="n">leeds_thermal</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1">#Set relevant method</span>
    <span class="k">if</span> <span class="n">prm</span><span class="o">.</span><span class="n">FeS_method</span> <span class="o">==</span> <span class="s1">&#39;isothermal&#39;</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">stable_layer_models</span><span class="o">.</span><span class="n">FeS</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">evolve</span> <span class="o">=</span> <span class="n">simple_isothermal_evolve</span>

        <span class="n">profiles</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span>
        <span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">T_cmb</span><span class="p">)</span> <span class="c1">#Isothermal initial state</span>

    <span class="k">elif</span> <span class="n">prm</span><span class="o">.</span><span class="n">FeS_method</span> <span class="o">==</span> <span class="s1">&#39;conducting&#39;</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">stable_layer_models</span><span class="o">.</span><span class="n">FeS</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">evolve</span> <span class="o">=</span> <span class="n">conducting_evolve</span>

        <span class="n">r_fes</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span> <span class="o">-</span> <span class="n">prm</span><span class="o">.</span><span class="n">FeS_size</span>

        <span class="c1">#Initialise bulk and fes profiles</span>
        <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;bulk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
                               <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])}</span>
        <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;fes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">r_fes</span><span class="p">,</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span><span class="p">,</span> <span class="mi">3</span><span class="p">)}</span> <span class="c1">#This will remain fixed throughout simulation.</span>

        <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;fes&#39;</span><span class="p">][</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;fes&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">model</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Tcen</span><span class="p">,</span> <span class="n">prm</span><span class="o">.</span><span class="n">core_adiabat_params</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Need to correctly specify method with FeS_method parameter&#39;</span><span class="p">)</span>

    <span class="c1">#Reset profiles with new temperature profile</span>
    <span class="n">prof</span><span class="o">.</span><span class="n">basic_profiles</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">prof</span><span class="o">.</span><span class="n">temp_dependent_profiles</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<span class="c1">#Add on extra required parameters</span>
<span class="n">required_params</span> <span class="o">=</span> <span class="n">leeds_thermal</span><span class="o">.</span><span class="n">required_params</span>
<span class="n">required_params</span><span class="p">[</span><span class="s1">&#39;FeS_size&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="s1">&#39;Size of the FeS layer&#39;</span>
<span class="n">required_params</span><span class="p">[</span><span class="s1">&#39;FeS_density&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="s1">&#39;Uniform density of liquid FeS&#39;</span>
<span class="n">required_params</span><span class="p">[</span><span class="s1">&#39;FeS_cp&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="s1">&#39;Uniform specific heat of liquid FeS&#39;</span>
<span class="n">required_params</span><span class="p">[</span><span class="s1">&#39;FeS_conductivity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Uniform thermal conductivity of liquid FeS&#39;</span>
<span class="n">required_params</span><span class="p">[</span><span class="s1">&#39;FeS_method&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="s1">&#39;String denoting method. Can be: </span><span class="se">\&#39;</span><span class="s1">isothermal</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">conducting</span><span class="se">\&#39;</span><span class="s1">&#39;</span>

<span class="n">optional_params</span> <span class="o">=</span> <span class="n">leeds_thermal</span><span class="o">.</span><span class="n">optional_params</span>



<span class="c1">### Redefine evolve method to account for FeS layer that is isothermal</span>
<div class="viewcode-block" id="simple_isothermal_evolve"><a class="viewcode-back" href="../../../../../thermal_history.thermal_history.stable_layer_models.FeS.main.html#thermal_history.thermal_history.stable_layer_models.FeS.main.simple_isothermal_evolve">[docs]</a><span class="k">def</span> <span class="nf">simple_isothermal_evolve</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Evolve the stable layer, taking into account the presence of a liquid FeS layer.</span>
<span class="sd">    Changes from leeds_thermal.main.evolve are commented by #!#</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : ThermalModel</span>
<span class="sd">        Main model class</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">sl</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">stable_layer</span>
    <span class="n">core</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">core</span>
    <span class="n">prm</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">Q_cmb</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">mantle</span><span class="o">.</span><span class="n">Q_cmb</span>

    <span class="n">fes_idx</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">_fes_idx</span>           <span class="c1">#!# FeS index for core radial arrays</span>
    <span class="n">r_fes</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span> <span class="o">-</span> <span class="n">prm</span><span class="o">.</span><span class="n">FeS_size</span>

    <span class="n">T_grad_cmb</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">Q_cmb</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">][</span><span class="n">fes_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ADR</span> <span class="o">=</span> <span class="n">T_grad_cmb</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;dTa_dr&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">ADR</span> <span class="o">=</span> <span class="n">ADR</span>

    <span class="c1">#Check if conditions are sub-adiabatic and a layer should begin to grow</span>
    <span class="n">check</span>  <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">pure_thermal_check</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#!# Always a least an FeS layer.</span>

    <span class="c1">#Initialise energies/entropies associated with this state.</span>
    <span class="n">Qs</span><span class="p">,</span> <span class="n">Es</span><span class="p">,</span> <span class="n">Ek</span><span class="p">,</span> <span class="n">Ej</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

    <span class="c1">#initialise BC&#39;s</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">lb_T</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">ub_T</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">T_grad_s</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">alpha_D</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">baro_grad</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#Check if Qcmb would give a layer this time-step.</span>
    <span class="k">if</span> <span class="n">sl</span><span class="o">.</span><span class="n">layer_thickness</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check</span><span class="p">:</span>

        <span class="n">sl</span><span class="o">.</span><span class="n">ds_dt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sl</span><span class="o">.</span><span class="n">dT_dt_s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sl</span><span class="o">.</span><span class="n">_next_profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">prm</span><span class="o">.</span><span class="n">max_resolution</span><span class="p">)</span><span class="o">*</span><span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span>
        <span class="n">sl</span><span class="o">.</span><span class="n">_next_profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">sl</span><span class="o">.</span><span class="n">_next_profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">core</span><span class="o">.</span><span class="n">Tcen</span><span class="p">,</span> <span class="n">prm</span><span class="o">.</span><span class="n">core_adiabat_params</span><span class="p">)</span>

    <span class="c1">#Otherwise run the method.</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="n">r_initial</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
        <span class="n">T_initial</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="n">r_initial</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r_initial</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


        <span class="c1">#Calculate Ek</span>
        <span class="k">if</span> <span class="n">dr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#Layer is still of 0 thickness</span>
            <span class="n">Ek</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dT_dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">T_initial</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">edge_order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r_initial</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span>
            <span class="n">Ek</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">r_initial</span><span class="p">,</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">dT_dr</span><span class="o">/</span><span class="n">T_initial</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">r_initial</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


        <span class="c1">#Time step model</span>
        <span class="n">simple_isothermal_FeS</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>  <span class="c1">#!# Changed to our new method</span>

        <span class="c1">#New radial profiles</span>
        <span class="n">r_new</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">_next_profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
        <span class="n">T_new</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">_next_profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>

        <span class="n">T_new</span> <span class="o">=</span> <span class="n">T_new</span><span class="p">[</span><span class="n">r_new</span> <span class="o">&lt;=</span> <span class="n">r_fes</span><span class="p">]</span> <span class="c1">#!# Just stable layer of the bulk, no FeS</span>
        <span class="n">r_new</span> <span class="o">=</span> <span class="n">r_new</span><span class="p">[</span><span class="n">r_new</span> <span class="o">&lt;=</span> <span class="n">r_fes</span><span class="p">]</span>
        
        <span class="c1">#Secular cooling. Compare final profiles to those at the beginning of the time-step.</span>
        <span class="k">if</span> <span class="n">r_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">r_initial</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1">#Layer has grown</span>

            <span class="c1">#Need to append on adiabat values onto initial temperatures</span>
            <span class="n">T_initial_temp</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">r_new</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Tcen</span><span class="p">,</span> <span class="n">prm</span><span class="o">.</span><span class="n">core_adiabat_params</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r_new</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">r_initial</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">T_initial_temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r_new</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r_initial</span><span class="p">,</span> <span class="n">T_initial</span><span class="p">)</span>
            <span class="n">T_initial</span> <span class="o">=</span> <span class="n">T_initial_temp</span>

            <span class="n">r1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T1</span> <span class="o">=</span> <span class="n">r_new</span><span class="p">,</span> <span class="n">T_new</span><span class="p">,</span> <span class="n">T_initial</span>

	    <span class="c1">#Set cooling rate at r=0 if no convecting region exists.</span>
            <span class="k">if</span> <span class="n">r_initial</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
               <span class="n">core</span><span class="o">.</span><span class="n">dT_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">T2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">T1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span>

        <span class="k">elif</span> <span class="n">r_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">r_initial</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1">#Layer has shrunk</span>

            <span class="c1">#Need to append on adiabatic values onto new temperature</span>
            <span class="n">T_new_temp</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">r_initial</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Tcen</span> <span class="o">+</span> <span class="n">core</span><span class="o">.</span><span class="n">dT_dt</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">prm</span><span class="o">.</span><span class="n">core_adiabat_params</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r_initial</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r_initial</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">r_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">T_new_temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r_initial</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r_new</span><span class="p">,</span> <span class="n">T_new</span><span class="p">)</span>

            <span class="n">T_new</span> <span class="o">=</span> <span class="n">T_new_temp</span>

            <span class="n">r1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T1</span> <span class="o">=</span> <span class="n">r_initial</span><span class="p">,</span> <span class="n">T_new</span><span class="p">,</span> <span class="n">T_initial</span>

        <span class="n">dT_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">T2</span><span class="o">-</span><span class="n">T1</span><span class="p">)</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span>
        
        <span class="n">cp</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">][:</span><span class="n">fes_idx</span><span class="p">],</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">][:</span><span class="n">fes_idx</span><span class="p">])</span> <span class="c1">#!# Just consider values below FeS</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">][:</span><span class="n">fes_idx</span><span class="p">],</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">][:</span><span class="n">fes_idx</span><span class="p">])</span> 
        <span class="n">Qs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">dT_dt</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">cp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Es</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">dT_dt</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">cp</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">T1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">T1</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sl</span><span class="o">.</span><span class="n">dT_dt_s</span> <span class="o">=</span> <span class="n">dT_dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1">#Save cooling rate at base of layer</span>


        <span class="c1">#!# Add on values for FeS cooling</span>
        <span class="n">Qs</span> <span class="o">+=</span> <span class="o">-</span><span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">r_fes</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">prm</span><span class="o">.</span><span class="n">FeS_density</span><span class="o">*</span><span class="n">prm</span><span class="o">.</span><span class="n">FeS_cp</span> <span class="o">*</span> <span class="n">sl</span><span class="o">.</span><span class="n">dT_dt_fes</span>
        <span class="n">Es</span> <span class="o">+=</span> <span class="mi">0</span> <span class="c1">#Operates @ T_cmb so no thermodynamic efficiency</span>

        <span class="n">Ej</span> <span class="o">=</span> <span class="n">Es</span> <span class="o">-</span> <span class="n">Ek</span>

    <span class="c1">#Save energies/entropies to model attributes</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">Qs</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">Es</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">Ek</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">Ej</span> <span class="o">=</span> <span class="n">Qs</span><span class="p">,</span> <span class="n">Es</span><span class="p">,</span> <span class="n">Ek</span><span class="p">,</span> <span class="n">Ej</span>

    <span class="c1">#Add onto core results</span>
    <span class="n">core</span><span class="o">.</span><span class="n">Qs</span> <span class="o">+=</span> <span class="n">Qs</span>
    <span class="n">core</span><span class="o">.</span><span class="n">Ej</span> <span class="o">+=</span> <span class="n">Ej</span>
    <span class="n">core</span><span class="o">.</span><span class="n">Es</span> <span class="o">+=</span> <span class="n">Es</span>
    <span class="n">core</span><span class="o">.</span><span class="n">Ek</span> <span class="o">+=</span> <span class="n">Ek</span>

    <span class="c1">#Make sure profiles have size maximum_resolution, so they can be saved.</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">prm</span><span class="o">.</span><span class="n">max_resolution</span><span class="p">:</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">prm</span><span class="o">.</span><span class="n">max_resolution</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span>

    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">prm</span><span class="o">.</span><span class="n">max_resolution</span><span class="p">:</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">prm</span><span class="o">.</span><span class="n">max_resolution</span><span class="o">-</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">prm</span><span class="o">.</span><span class="n">max_resolution</span><span class="o">-</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">,</span> <span class="n">T</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;Ta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Tcen</span><span class="p">,</span> <span class="n">prm</span><span class="o">.</span><span class="n">core_adiabat_params</span><span class="p">)</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">T_cmb</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">T_s</span><span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">core</span><span class="o">.</span><span class="n">T_cmb</span><span class="p">,</span>  <span class="n">core</span><span class="o">.</span><span class="n">T_s</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">T_cmb</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">T_s</span></div>


<span class="c1">#Thermal method with FeS</span>
<div class="viewcode-block" id="simple_isothermal_FeS"><a class="viewcode-back" href="../../../../../thermal_history.thermal_history.stable_layer_models.FeS.main.html#thermal_history.thermal_history.stable_layer_models.FeS.main.simple_isothermal_FeS">[docs]</a><span class="k">def</span> <span class="nf">simple_isothermal_FeS</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Simple model taking the temperature of the FeS layer to be uniform.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : ThermalModel</span>
<span class="sd">        Main model class</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#All deviations from leeds_thermal.pure_thermal_method are commented starting with #!#</span>
    <span class="c1">#to highlight them.</span>


    <span class="n">core</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">core</span>
    <span class="n">sl</span>  <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">stable_layer</span>
    <span class="n">prm</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span>

    <span class="c1">#Read in values from model</span>
    <span class="n">layer_thickness</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">layer_thickness</span>
    <span class="n">r_s</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span> <span class="o">-</span> <span class="n">layer_thickness</span>
    <span class="n">r_s_original</span> <span class="o">=</span> <span class="n">r_s</span><span class="o">*</span><span class="mi">1</span>

    <span class="n">r_cmb</span>      <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">resolution</span>
    <span class="n">min_res</span>    <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">min_resolution</span>
    <span class="n">max_res</span>    <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">max_resolution</span>

    <span class="n">TOL</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">depth_tolerance</span>                   <span class="c1"># Minimum layer size</span>
    <span class="n">init_size</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">init_size</span> <span class="o">+</span> <span class="n">prm</span><span class="o">.</span><span class="n">FeS_size</span>  <span class="c1">#!# Stable layer must start below FeS layer </span>

    <span class="n">core_adiabat</span>      <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">core_adiabat_params</span>
    <span class="n">rho_poly</span>          <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">core_liquid_density_params</span>

    <span class="n">E_T</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">entrainment_T</span>

    <span class="n">Tcen</span>   <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Tcen</span>
    <span class="n">dTa_dt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">dT_dt</span>

    <span class="c1">#!# Base of FeS layer</span>
    <span class="n">r_fes</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span> <span class="o">-</span> <span class="n">prm</span><span class="o">.</span><span class="n">FeS_size</span>

    <span class="c1">#!# Existing radial profiles excluding FeS layer</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">][</span><span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">r_fes</span><span class="p">]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">r_fes</span><span class="p">]</span>

    <span class="c1">#!# Evolve temperature of FeS layer</span>
    <span class="k">if</span> <span class="n">layer_thickness</span> <span class="o">&gt;</span> <span class="n">prm</span><span class="o">.</span><span class="n">FeS_size</span><span class="p">:</span>
        <span class="n">k_fes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r_fes</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span> <span class="c1">#Get value on lower side of boundary</span>
        <span class="n">T_grad_fes</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">core</span><span class="o">.</span><span class="n">Q_fes</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span><span class="n">r_fes</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">k_fes</span> <span class="o">*</span> <span class="n">T_grad_fes</span>

        <span class="n">dQ</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Q_cmb</span> <span class="o">-</span> <span class="n">core</span><span class="o">.</span><span class="n">Q_fes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dQ</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Q_cmb</span> <span class="o">-</span> <span class="n">core</span><span class="o">.</span><span class="n">Q_rs</span>

    <span class="c1">#Cooling rate of FeS layer</span>
    <span class="n">Qs_tilde</span> <span class="o">=</span> <span class="o">-</span><span class="n">prm</span><span class="o">.</span><span class="n">FeS_density</span><span class="o">*</span><span class="n">prm</span><span class="o">.</span><span class="n">FeS_cp</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">r_fes</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#* (core.T_cmb/core.Tcen)</span>
    <span class="n">dT_dt_fes</span> <span class="o">=</span> <span class="n">dQ</span><span class="o">/</span><span class="n">Qs_tilde</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">dT_dt_fes</span> <span class="o">=</span> <span class="n">dT_dt_fes</span>

    <span class="c1">#!# ADR defined at r_fes rather than r_cmb</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">ADR</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Q_fes</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;Qa&#39;</span><span class="p">][</span><span class="n">core</span><span class="o">.</span><span class="n">_fes_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">#!#Only run if stable layer needs to calculated.</span>
    <span class="c1">#!#Skip the first iteration as mantle model often gives small heat flows before jumping up again. This messes up the thermal evolution.</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">it</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sl</span><span class="o">.</span><span class="n">ADR</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">layer_thickness</span> <span class="o">&gt;</span> <span class="n">prm</span><span class="o">.</span><span class="n">FeS_size</span><span class="p">):</span>

        <span class="c1">#For stability, reduce the time step size when layer is relatively thin.</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">time_gone</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">time_gone</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">dt</span><span class="p">:</span>


            <span class="c1">#Initialise layer with minium tolerance thickness</span>
            <span class="k">if</span> <span class="n">layer_thickness</span> <span class="o">&lt;</span> <span class="n">TOL</span><span class="o">+</span><span class="n">prm</span><span class="o">.</span><span class="n">FeS_size</span><span class="p">:</span>       <span class="c1">#!# stable layer must start below FeS layer</span>

                <span class="n">layer_thickness</span> <span class="o">=</span> <span class="n">init_size</span>
                <span class="n">r_s</span> <span class="o">=</span> <span class="n">r_cmb</span> <span class="o">-</span> <span class="n">layer_thickness</span>

                <span class="c1">#Number of grid points in this iteration</span>
                <span class="n">n_points</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">min_res</span><span class="p">,</span><span class="n">layer_thickness</span><span class="o">*</span><span class="n">resolution</span><span class="p">]))</span>
                <span class="n">n_points</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">max_res</span><span class="p">,</span><span class="n">n_points</span><span class="p">]))</span>

                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">r_s</span><span class="p">,</span> <span class="n">r_fes</span><span class="p">,</span> <span class="n">n_points</span><span class="p">)</span> <span class="c1">#!# only upto r_fes</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Tcen</span><span class="p">,</span> <span class="n">core_adiabat</span><span class="p">)</span>


            <span class="c1">#Set timestep</span>
            <span class="n">dt_small</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dt</span><span class="o">*</span><span class="n">factor</span>

            <span class="k">if</span> <span class="n">time_gone</span> <span class="o">+</span> <span class="n">dt_small</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">dt</span><span class="p">:</span>
                <span class="n">dt_small</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dt</span> <span class="o">-</span> <span class="n">time_gone</span>

            <span class="n">fes_idx</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">_fes_idx</span> <span class="c1">#!# We want values below FeS layer</span>
            <span class="c1">#Regrid core radial profiles onto finer stable layer grid</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">density</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rho_poly</span><span class="p">)</span>
            <span class="n">k</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">][:</span><span class="n">fes_idx</span><span class="p">],</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">][:</span><span class="n">fes_idx</span><span class="p">])</span>
            <span class="n">dk_dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">edge_order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">cp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">][:</span><span class="n">fes_idx</span><span class="p">],</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">][:</span><span class="n">fes_idx</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">][:</span><span class="n">fes_idx</span><span class="p">],</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">][:</span><span class="n">fes_idx</span><span class="p">])</span>

            <span class="c1">#Thermal diffusivity</span>
            <span class="n">D_T</span> <span class="o">=</span> <span class="n">k</span><span class="o">/</span><span class="p">(</span><span class="n">rho</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span>

            <span class="c1">#Cool adiabat</span>
            <span class="n">Tcen</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Tcen</span> <span class="o">+</span> <span class="n">dTa_dt</span><span class="o">*</span><span class="p">(</span><span class="n">time_gone</span><span class="o">+</span><span class="n">dt_small</span><span class="p">)</span>

            <span class="n">Ta</span><span class="p">,</span> <span class="n">Ta_grad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Tcen</span><span class="p">,</span> <span class="n">core_adiabat</span><span class="p">),</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat_grad</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Tcen</span><span class="p">,</span> <span class="n">core_adiabat</span><span class="p">)</span>

            <span class="c1">#Lower boundary condition (using entrainment)</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">E_T</span><span class="p">)</span><span class="o">*</span><span class="n">Ta_grad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># lb = prof.adiabat_grad(r, core.Tcen, core_adiabat)[0]</span>
            <span class="n">lb_type</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1">#If whole core is stratified, lower BC should be zero flux</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lb</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1">#!# Fixed T upper boundary condition</span>
            <span class="n">ub_type</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">T_cmb</span> <span class="o">+</span> <span class="n">dT_dt_fes</span><span class="o">*</span><span class="p">(</span><span class="n">time_gone</span><span class="o">+</span><span class="n">dt_small</span><span class="p">)</span>

            <span class="c1">#Calculate diffusion solution</span>
            <span class="n">T_new</span> <span class="o">=</span> <span class="n">diffusion</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">dt_small</span><span class="p">,</span> <span class="n">D_T</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dk_dr</span><span class="p">,</span> <span class="p">(</span><span class="n">lb_type</span><span class="p">,</span><span class="n">lb</span><span class="p">),(</span><span class="n">ub_type</span><span class="p">,</span> <span class="n">ub</span><span class="p">))</span>

            <span class="c1"># plt.plot(r, T_new-Ta, &#39;o-&#39;)</span>
            <span class="c1"># plt.show()</span>
            <span class="c1"># breakpoint()</span>


            <span class="c1">#Mix layer (experimental function, not used by default)</span>
            <span class="k">if</span> <span class="n">prm</span><span class="o">.</span><span class="n">mix_layer</span><span class="p">:</span>
                <span class="n">T_rel</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">mix_profile</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cp</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">T_new</span><span class="o">-</span><span class="n">Ta</span><span class="p">)</span>
                <span class="n">T_new</span> <span class="o">=</span> <span class="n">T_rel</span> <span class="o">+</span> <span class="n">Ta</span>

            <span class="c1">#Determine if layer should retreat</span>
            <span class="n">r_s_new</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">retreat_layer</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">T_new</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">Tcen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core_adiabat</span><span class="p">,</span> <span class="p">(</span><span class="n">resolution</span><span class="p">,</span><span class="n">min_res</span><span class="p">,</span><span class="n">max_res</span><span class="p">),</span> <span class="n">alpha</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1">#while core is stratified</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sl</span><span class="o">.</span><span class="n">ADR</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">r_s_new</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1">#Grow layer</span>
            <span class="k">elif</span> <span class="n">r_s_new</span> <span class="o">==</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>

                <span class="c1">#Find radius on adiabat that matches temperature at base of layer</span>
                <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">Tcen</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">T</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span><span class="n">Tcen</span><span class="p">,</span><span class="n">core_adiabat</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">T_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">Tcen</span><span class="p">:</span> <span class="c1">#Layer has reached center of core</span>
                    <span class="n">r_s_new</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#!# Limit search to 0 -&gt; r_fes</span>
                    <span class="n">r_s_new</span> <span class="o">=</span> <span class="n">bisect</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">r_fes</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">T_new</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Tcen</span><span class="p">),</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> 

            <span class="c1">#Shrink layer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#Give up if layer will still not grow after generous time step increases.</span>
                <span class="k">if</span> <span class="n">r_s_new</span> <span class="o">&gt;=</span> <span class="n">r_fes</span><span class="o">-</span><span class="n">TOL</span><span class="p">:</span>     <span class="c1">#!# replaced r_cmb with r_fes</span>
                    <span class="nb">breakpoint</span><span class="p">()</span>
                    <span class="c1">#No stratification</span>
                    <span class="n">r_s_new</span> <span class="o">=</span> <span class="n">r_fes</span>        <span class="c1">#!# replaced r_cmb with r_fes</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span><span class="o">/</span><span class="mi">2</span>      <span class="c1">#!# works better with smaller timestep</span>
                    <span class="n">time_gone</span> <span class="o">=-</span> <span class="n">dt_small</span>  <span class="c1">#¡# Reset timer back to start</span>

                    <span class="k">if</span> <span class="n">factor</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="ow">or</span> <span class="n">sl</span><span class="o">.</span><span class="n">ADR</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">dt_small</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dt</span> <span class="o">-</span> <span class="n">time_gone</span>
                        <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">layer_thickness</span> <span class="o">=</span> <span class="n">r_cmb</span> <span class="o">-</span> <span class="n">r_s_new</span>

            <span class="c1">#Regrid domain, keeping temperature relative to the adiabat.</span>
            <span class="n">T_rel</span> <span class="o">=</span> <span class="n">T_new</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Tcen</span><span class="p">,</span> <span class="n">core_adiabat</span><span class="p">)</span>

            <span class="n">r</span><span class="p">,</span> <span class="n">T_rel</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">change_domain_size</span><span class="p">(</span><span class="n">T_rel</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_s_new</span><span class="p">,</span> <span class="p">(</span><span class="n">resolution</span><span class="p">,</span><span class="n">min_res</span><span class="p">,</span><span class="n">max_res</span><span class="p">))</span>

            <span class="n">T</span> <span class="o">=</span> <span class="n">T_rel</span> <span class="o">+</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Tcen</span><span class="p">,</span> <span class="n">core_adiabat</span><span class="p">)</span>

            <span class="n">time_gone</span> <span class="o">+=</span> <span class="n">dt_small</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#!# No stable layer growth</span>
        <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">r_s_new</span> <span class="o">=</span> <span class="n">r_fes</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">r_fes</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">T_cmb</span><span class="o">+</span><span class="n">dT_dt_fes</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

    <span class="c1">#!# Add on radial profiles of FeS layer</span>
    <span class="n">r_fes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">r_fes</span><span class="p">,</span> <span class="n">r_cmb</span><span class="p">,</span> <span class="mi">10</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">T_fes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">r_fes</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">T_cmb</span><span class="o">+</span><span class="n">dT_dt_fes</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r_fes</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">T_fes</span><span class="p">)</span>

    <span class="c1">#Save new profiles. Keep original profiles until update() has been called.</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">_next_profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">_next_profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>

    <span class="c1"># if layer_thickness &gt; prm.FeS_size:</span>
    <span class="c1">#     import matplotlib.pyplot as plt</span>
    <span class="c1">#     plt.plot(r, T, &#39;ro--&#39;)</span>
    <span class="c1">#     # plt.show()</span>
    <span class="c1">#     # breakpoint()</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">ds_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_s_new</span> <span class="o">-</span> <span class="n">r_s_original</span><span class="p">)</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span>

    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sl</span><span class="o">.</span><span class="n">T_grad_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sl</span><span class="o">.</span><span class="n">T_grad_s</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">lb_T</span> <span class="o">=</span> <span class="n">lb</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">ub_T</span> <span class="o">=</span> <span class="n">ub</span></div>







<span class="c1">#!# evolve method to account for FeS layer that is thermally conducting</span>
<div class="viewcode-block" id="conducting_evolve"><a class="viewcode-back" href="../../../../../thermal_history.thermal_history.stable_layer_models.FeS.main.html#thermal_history.thermal_history.stable_layer_models.FeS.main.conducting_evolve">[docs]</a><span class="k">def</span> <span class="nf">conducting_evolve</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Evolve the stable layer, taking into account the presence of a liquid FeS layer.</span>
<span class="sd">    Changes from leeds_thermal.main.evolve are commented by #!#</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : ThermalModel</span>
<span class="sd">        Main model class</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">sl</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">stable_layer</span>
    <span class="n">core</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">core</span>
    <span class="n">prm</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">Q_cmb</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">mantle</span><span class="o">.</span><span class="n">Q_cmb</span>

    <span class="n">fes_idx</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">_fes_idx</span>           <span class="c1">#!# FeS index for core radial arrays</span>
    <span class="n">r_fes</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span> <span class="o">-</span> <span class="n">prm</span><span class="o">.</span><span class="n">FeS_size</span>

    <span class="n">T_grad_cmb</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">Q_cmb</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">][</span><span class="n">fes_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ADR</span> <span class="o">=</span> <span class="n">T_grad_cmb</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;dTa_dr&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">ADR</span> <span class="o">=</span> <span class="n">ADR</span>

    <span class="c1">#Check if conditions are sub-adiabatic and a layer should begin to grow</span>
    <span class="n">check</span>  <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">pure_thermal_check</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#!# Always a least an FeS layer.</span>

    <span class="c1">#Initialise energies/entropies associated with this state.</span>
    <span class="n">Qs</span><span class="p">,</span> <span class="n">Es</span><span class="p">,</span> <span class="n">Ek</span><span class="p">,</span> <span class="n">Ej</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

    <span class="c1">#initialise BC&#39;s</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">lb_T</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">ub_T</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">T_grad_s</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">alpha_D</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">baro_grad</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#Run the method.</span>
    <span class="n">r_initial</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
    <span class="n">T_initial</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="n">r_initial</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r_initial</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1">#Calculate Ek</span>
    <span class="k">if</span> <span class="n">dr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#Layer is still of 0 thickness</span>
        <span class="n">Ek</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dT_dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">T_initial</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">edge_order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r_initial</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span>
        <span class="n">Ek</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">r_initial</span><span class="p">,</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">dT_dr</span><span class="o">/</span><span class="n">T_initial</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">r_initial</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">#Time step model</span>
    <span class="n">conducting_FeS</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>  <span class="c1">#!# Changed to our new method</span>

    <span class="c1">#New radial profiles</span>
    <span class="n">r_new</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">_next_profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
    <span class="n">T_new</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">_next_profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>

    <span class="c1">#Secular cooling. Compare final profiles to those at the beginning of the time-step.</span>
    <span class="k">if</span> <span class="n">r_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">r_initial</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1">#Layer has grown</span>

        <span class="c1">#Need to append on adiabat values onto initial temperatures</span>
        <span class="n">T_initial_temp</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">r_new</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Tcen</span><span class="p">,</span> <span class="n">prm</span><span class="o">.</span><span class="n">core_adiabat_params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r_new</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">r_initial</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">T_initial_temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r_new</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r_initial</span><span class="p">,</span> <span class="n">T_initial</span><span class="p">)</span>
        <span class="n">T_initial</span> <span class="o">=</span> <span class="n">T_initial_temp</span>

        <span class="n">r1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T1</span> <span class="o">=</span> <span class="n">r_new</span><span class="p">,</span> <span class="n">T_new</span><span class="p">,</span> <span class="n">T_initial</span>

    <span class="c1">#Set cooling rate at r=0 if no convecting region exists.</span>
        <span class="k">if</span> <span class="n">r_initial</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">dT_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">T2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">T1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span>

    <span class="k">elif</span> <span class="n">r_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">r_initial</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1">#Layer has shrunk</span>

        <span class="c1">#Need to append on adiabatic values onto new temperature</span>
        <span class="n">T_new_temp</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">r_initial</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Tcen</span> <span class="o">+</span> <span class="n">core</span><span class="o">.</span><span class="n">dT_dt</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">prm</span><span class="o">.</span><span class="n">core_adiabat_params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r_initial</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r_initial</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">r_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">T_new_temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r_initial</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r_new</span><span class="p">,</span> <span class="n">T_new</span><span class="p">)</span>

        <span class="n">T_new</span> <span class="o">=</span> <span class="n">T_new_temp</span>

        <span class="n">r1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T1</span> <span class="o">=</span> <span class="n">r_initial</span><span class="p">,</span> <span class="n">T_new</span><span class="p">,</span> <span class="n">T_initial</span>

    <span class="n">dT_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">T2</span><span class="o">-</span><span class="n">T1</span><span class="p">)</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span>
    
    <span class="n">cp</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">])</span> <span class="c1">#!# Just consider values below FeS</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">])</span> 
    <span class="n">Qs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">dT_dt</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">cp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Es</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">dT_dt</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">cp</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">T1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">T1</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">dT_dt_s</span> <span class="o">=</span> <span class="n">dT_dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1">#Save cooling rate at base of layer</span>

    <span class="n">Ej</span> <span class="o">=</span> <span class="n">Es</span> <span class="o">-</span> <span class="n">Ek</span>

    <span class="c1">#Save energies/entropies to model attributes</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">Qs</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">Es</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">Ek</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">Ej</span> <span class="o">=</span> <span class="n">Qs</span><span class="p">,</span> <span class="n">Es</span><span class="p">,</span> <span class="n">Ek</span><span class="p">,</span> <span class="n">Ej</span>

    <span class="c1">#Add onto core results</span>
    <span class="n">core</span><span class="o">.</span><span class="n">Qs</span> <span class="o">+=</span> <span class="n">Qs</span>
    <span class="n">core</span><span class="o">.</span><span class="n">Ej</span> <span class="o">+=</span> <span class="n">Ej</span>
    <span class="n">core</span><span class="o">.</span><span class="n">Es</span> <span class="o">+=</span> <span class="n">Es</span>
    <span class="n">core</span><span class="o">.</span><span class="n">Ek</span> <span class="o">+=</span> <span class="n">Ek</span>

    <span class="c1">#Make sure profiles have size maximum_resolution, so they can be saved.</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>

    <span class="c1">#!# For now we won&#39;t worry about profiles at each time step having the same size.</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">prm</span><span class="o">.</span><span class="n">max_resolution</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1"># r = linspace(sl.profiles[&#39;r&#39;][0], sl.profiles[&#39;r&#39;][-1], prm.max_resolution)</span>
        <span class="c1"># T = np.interp(r, sl.profiles[&#39;r&#39;], sl.profiles[&#39;T&#39;])</span>

    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">prm</span><span class="o">.</span><span class="n">max_resolution</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1"># r = np.append(sl.profiles[&#39;r&#39;], np.ones(prm.max_resolution-n)*sl.profiles[&#39;r&#39;][-1])</span>
        <span class="c1"># T = np.append(sl.profiles[&#39;T&#39;], np.ones(prm.max_resolution-n)*sl.profiles[&#39;T&#39;][-1])</span>

    <span class="c1"># else:</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">,</span> <span class="n">T</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;Ta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Tcen</span><span class="p">,</span> <span class="n">prm</span><span class="o">.</span><span class="n">core_adiabat_params</span><span class="p">)</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">T_cmb</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">T_s</span><span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">core</span><span class="o">.</span><span class="n">T_cmb</span><span class="p">,</span>  <span class="n">core</span><span class="o">.</span><span class="n">T_s</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">T_cmb</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">T_s</span></div>


<span class="c1">#!# Thermal method with FeS</span>
<div class="viewcode-block" id="conducting_FeS"><a class="viewcode-back" href="../../../../../thermal_history.thermal_history.stable_layer_models.FeS.main.html#thermal_history.thermal_history.stable_layer_models.FeS.main.conducting_FeS">[docs]</a><span class="k">def</span> <span class="nf">conducting_FeS</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Simple model taking the temperature of the FeS layer to be uniform.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : ThermalModel</span>
<span class="sd">        Main model class</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#All deviations from leeds_thermal.pure_thermal_method are commented starting with #!#</span>
    <span class="c1">#to highlight them.</span>


    <span class="n">core</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">core</span>
    <span class="n">sl</span>  <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">stable_layer</span>
    <span class="n">prm</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span>

    <span class="c1">#Read in values from model</span>
    <span class="n">layer_thickness</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">layer_thickness</span>
    <span class="n">r_s</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span> <span class="o">-</span> <span class="n">layer_thickness</span>
    <span class="n">r_s_original</span> <span class="o">=</span> <span class="n">r_s</span><span class="o">*</span><span class="mi">1</span>

    <span class="n">r_cmb</span>      <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">resolution</span>
    <span class="n">min_res</span>    <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">min_resolution</span>
    <span class="n">max_res</span>    <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">max_resolution</span>

    <span class="n">TOL</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">depth_tolerance</span>                   <span class="c1"># Minimum layer size</span>
    <span class="n">init_size</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">init_size</span> <span class="o">+</span> <span class="n">prm</span><span class="o">.</span><span class="n">FeS_size</span>  <span class="c1">#!# Stable layer must start below FeS layer </span>

    <span class="n">core_adiabat</span>      <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">core_adiabat_params</span>
    <span class="n">rho_poly</span>          <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">core_liquid_density_params</span>

    <span class="n">E_T</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">entrainment_T</span>

    <span class="n">Tcen</span>   <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Tcen</span>
    <span class="n">dTa_dt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">dT_dt</span>

    <span class="c1">#!# Base of FeS layer</span>
    <span class="n">r_fes</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">r_cmb</span> <span class="o">-</span> <span class="n">prm</span><span class="o">.</span><span class="n">FeS_size</span>
    <span class="n">fes_idx</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">_fes_idx</span>

    <span class="c1">#Temperature gradient at CMB</span>
    <span class="n">T_grad_cmb</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Q_cmb</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">r_cmb</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1">#!# Temp in the FeS layer. </span>
    <span class="c1">#!# Tracking profiles specific to FeS layer helps make sure Q_fes can be calculated</span>
    <span class="n">r_prof_fes</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;fes&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
    <span class="n">T_prof_fes</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;fes&#39;</span><span class="p">][</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>

    <span class="c1">#!# Temp in the FeS layer. </span>
    <span class="c1">#!# Tracking profiles specific to FeS layer helps make sure Q_fes can be calculated</span>
    <span class="n">r_prof_bulk</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;bulk&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
    <span class="n">T_prof_bulk</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;bulk&#39;</span><span class="p">][</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        

    <span class="n">core</span><span class="o">.</span><span class="n">Q_fes</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">r_fes</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">prm</span><span class="o">.</span><span class="n">FeS_conductivity</span> <span class="o">*</span> <span class="o">-</span><span class="p">(</span><span class="n">T_prof_fes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">T_prof_fes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">r_prof_fes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r_prof_fes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


    <span class="c1">#!# ADR defined at r_fes rather than r_cmb</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">ADR</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Q_fes</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;Qa&#39;</span><span class="p">][</span><span class="n">core</span><span class="o">.</span><span class="n">_fes_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">#For stability, reduce the time step size when layer is relatively thin.</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">time_gone</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">time_gone</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">dt</span><span class="p">:</span>

        <span class="c1">#!# Only solve for FeS layer unless ADR&lt;1</span>
        <span class="k">if</span> <span class="n">sl</span><span class="o">.</span><span class="n">ADR</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>

            
            <span class="c1">#!# Number of grid points in the bulk this iteration</span>
            <span class="n">n_points</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">min_res</span><span class="p">,</span><span class="n">layer_thickness</span><span class="o">*</span><span class="n">resolution</span><span class="p">]))</span>
            <span class="n">n_points</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">max_res</span><span class="p">,</span><span class="n">n_points</span><span class="p">]))</span>

            <span class="c1">#Initialise layer with minium tolerance thickness</span>
            <span class="k">if</span> <span class="n">layer_thickness</span> <span class="o">&lt;</span> <span class="n">TOL</span><span class="o">+</span><span class="n">prm</span><span class="o">.</span><span class="n">FeS_size</span><span class="p">:</span>       <span class="c1">#!# stable layer must start below FeS layer</span>
                <span class="n">layer_thickness</span> <span class="o">=</span> <span class="n">init_size</span>
                <span class="n">r_s</span> <span class="o">=</span> <span class="n">r_cmb</span> <span class="o">-</span> <span class="n">layer_thickness</span>
                

                <span class="n">r_prof_bulk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">r_s</span><span class="p">,</span> <span class="n">r_fes</span><span class="p">,</span> <span class="n">n_points</span><span class="p">)</span> <span class="c1">#!# only upto to grid space of r_fes. FeS profiles will get appended to these profiles.</span>
                <span class="n">T_prof_bulk</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">r_prof_bulk</span><span class="p">,</span> <span class="n">Tcen</span><span class="p">,</span> <span class="n">core_adiabat</span><span class="p">)</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;bulk&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_prof_bulk</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;bulk&#39;</span><span class="p">][</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_prof_bulk</span>

            
            <span class="c1">#!# Interpolate stable layer in the bulk onto new grid for this iteration.</span>
            <span class="n">r_prof_bulk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">r_s</span><span class="p">,</span> <span class="n">r_fes</span><span class="p">,</span> <span class="n">n_points</span><span class="p">)</span> 
            <span class="n">T_prof_bulk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r_prof_bulk</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;bulk&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;bulk&#39;</span><span class="p">][</span><span class="s1">&#39;T&#39;</span><span class="p">])</span>

            <span class="c1">#!# Radial profiles over whole conducting region</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_prof_bulk</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">r_prof_fes</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T_prof_bulk</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">T_prof_fes</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#!# Just the FeS layer is conducting</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">r_prof_fes</span><span class="p">,</span> <span class="n">T_prof_fes</span>

        <span class="c1">#Set timestep</span>
        <span class="n">dt_small</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dt</span><span class="o">*</span><span class="n">factor</span>

        <span class="k">if</span> <span class="n">time_gone</span> <span class="o">+</span> <span class="n">dt_small</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">dt</span><span class="p">:</span>
            <span class="n">dt_small</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dt</span> <span class="o">-</span> <span class="n">time_gone</span>

        <span class="c1">#Regrid core radial profiles onto finer stable layer grid</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">density</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rho_poly</span><span class="p">)</span>
        <span class="n">k</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span>
        <span class="n">dk_dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">edge_order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">])</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">core</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">])</span>

        <span class="c1"># Thermal diffusivity</span>
        <span class="n">D_T</span> <span class="o">=</span> <span class="n">k</span><span class="o">/</span><span class="p">(</span><span class="n">rho</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span>

        <span class="c1">#Cool adiabat</span>
        <span class="n">Tcen</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Tcen</span> <span class="o">+</span> <span class="n">dTa_dt</span><span class="o">*</span><span class="p">(</span><span class="n">time_gone</span><span class="o">+</span><span class="n">dt_small</span><span class="p">)</span>

        <span class="n">Ta</span><span class="p">,</span> <span class="n">Ta_grad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Tcen</span><span class="p">,</span> <span class="n">core_adiabat</span><span class="p">),</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat_grad</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Tcen</span><span class="p">,</span> <span class="n">core_adiabat</span><span class="p">)</span>

        <span class="c1">#!# Fixed value if bulk is convecting</span>
        <span class="k">if</span> <span class="n">sl</span><span class="o">.</span><span class="n">ADR</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">Ta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lb_type</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#Lower boundary condition (using entrainment)</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">E_T</span><span class="p">)</span><span class="o">*</span><span class="n">Ta_grad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># lb = prof.adiabat_grad(r, core.Tcen, core_adiabat)[0]</span>
            <span class="n">lb_type</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1">#If whole core is stratified, lower BC should be zero flux</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#Upper bc based on Q_cmb</span>
        <span class="n">ub_type</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">T_grad_cmb</span>

        <span class="c1">#Calculate diffusion solution</span>
        <span class="c1">#!# Check if standard diffusion solution is needed or new method with discontinuity in k</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">r_fes</span><span class="p">:</span>
            <span class="c1">#Just FeS layer. diffusion_uneven() gives same results as diffusion() from leeds_thermal if</span>
            <span class="c1">#uniform grid is used. Can support an uneven grid spacing if needed.</span>
            <span class="n">T_new</span> <span class="o">=</span> <span class="n">diffusion_uneven</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">dt_small</span><span class="p">,</span> <span class="n">D_T</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dk_dr</span><span class="p">,</span> <span class="p">(</span><span class="n">lb_type</span><span class="p">,</span><span class="n">lb</span><span class="p">),(</span><span class="n">ub_type</span><span class="p">,</span> <span class="n">ub</span><span class="p">))</span> <span class="c1">#!# Uneven grid.</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1">#!# For diffusion solution with a discontinuity, constant material properties in each</span>
            <span class="c1">#!# region are assumed for now.</span>

            <span class="c1">#Check values are constant</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">rho</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">k</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">r</span><span class="o">&lt;</span><span class="n">r_fes</span><span class="p">])))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Diffusion solution with discontinuity in k assumes rho, cp, k are constant in radius in bulk&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">r</span><span class="o">&gt;</span><span class="n">r_fes</span><span class="p">])))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Diffusion solution with discontinuity in k assumes rho, cp, k are constant in radius in FeS&#39;</span><span class="p">)</span>

            <span class="c1">#!# Thermal diffusivity</span>
            <span class="n">D_lower</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">rho</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">D_upper</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">rho</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">k_lower</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">k_upper</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1">#!# Diffusion solution for a discontinuity in k.</span>
            <span class="n">T_new</span> <span class="o">=</span> <span class="n">diffusion_discont</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_fes</span><span class="p">,</span> <span class="n">dt_small</span><span class="p">,</span> <span class="n">D_lower</span><span class="p">,</span> <span class="n">D_upper</span><span class="p">,</span> <span class="n">k_lower</span><span class="p">,</span> <span class="n">k_upper</span><span class="p">,</span> <span class="p">(</span><span class="n">lb_type</span><span class="p">,</span> <span class="n">lb</span><span class="p">),</span> <span class="p">(</span><span class="n">ub_type</span><span class="p">,</span> <span class="n">ub</span><span class="p">))</span>


        <span class="c1">#!# Only need to change layer thickness if stable layer will grow/receed.</span>
        <span class="k">if</span> <span class="n">sl</span><span class="o">.</span><span class="n">ADR</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">layer_thickness</span> <span class="o">&gt;</span> <span class="n">prm</span><span class="o">.</span><span class="n">FeS_size</span><span class="p">:</span>
            <span class="c1">#Mix layer (experimental function, not used by default)</span>
            <span class="k">if</span> <span class="n">prm</span><span class="o">.</span><span class="n">mix_layer</span><span class="p">:</span>
                <span class="n">T_rel</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">mix_profile</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cp</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">T_new</span><span class="o">-</span><span class="n">Ta</span><span class="p">)</span>
                <span class="n">T_new</span> <span class="o">=</span> <span class="n">T_rel</span> <span class="o">+</span> <span class="n">Ta</span>

            <span class="c1">#Determine if layer should retreat</span>
            <span class="c1">#!# Just consider areas below FeS layer</span>
            <span class="n">r_s_new</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">retreat_layer</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">r</span><span class="o">&lt;</span><span class="n">r_fes</span><span class="p">],</span> <span class="n">T_new</span><span class="p">[</span><span class="n">r</span><span class="o">&lt;</span><span class="n">r_fes</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">size</span><span class="p">)[</span><span class="n">r</span><span class="o">&lt;</span><span class="n">r_fes</span><span class="p">],</span> <span class="n">Tcen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core_adiabat</span><span class="p">,</span> <span class="p">(</span><span class="n">resolution</span><span class="p">,</span><span class="n">min_res</span><span class="p">,</span><span class="n">max_res</span><span class="p">),</span> <span class="n">alpha</span><span class="p">[</span><span class="n">r</span><span class="o">&lt;</span><span class="n">r_fes</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1">#while core is stratified</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sl</span><span class="o">.</span><span class="n">ADR</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">r_s_new</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1">#Grow layer</span>
            <span class="k">elif</span> <span class="n">r_s_new</span> <span class="o">==</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>

                <span class="c1">#Find radius on adiabat that matches temperature at base of layer</span>
                <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">Tcen</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">T</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span><span class="n">Tcen</span><span class="p">,</span><span class="n">core_adiabat</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">T_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">Tcen</span><span class="p">:</span> <span class="c1">#Layer has reached center of core</span>
                    <span class="n">r_s_new</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#!# Limit search to 0 -&gt; r_fes</span>
                    <span class="n">r_s_new</span> <span class="o">=</span> <span class="n">bisect</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">r_fes</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">T_new</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Tcen</span><span class="p">),</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> 

            <span class="c1">#Shrink layer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#Give up if layer will still not grow after generous time step increases.</span>
                <span class="k">if</span> <span class="n">r_s_new</span> <span class="o">&gt;=</span> <span class="n">r_fes</span><span class="o">-</span><span class="n">TOL</span><span class="p">:</span>     <span class="c1">#!# replaced r_cmb with r_fes</span>

                    <span class="c1">#No stratification</span>
                    <span class="n">r_s_new</span> <span class="o">=</span> <span class="n">r_fes</span>        <span class="c1">#!# replaced r_cmb with r_fes</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span><span class="o">*</span><span class="mi">2</span>      
                    <span class="n">time_gone</span> <span class="o">=-</span> <span class="n">dt_small</span>  <span class="c1">#¡# Reset timer back to start</span>

                    <span class="k">if</span> <span class="n">factor</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="ow">or</span> <span class="n">sl</span><span class="o">.</span><span class="n">ADR</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">dt_small</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dt</span> <span class="o">-</span> <span class="n">time_gone</span>
                        <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>



            <span class="n">layer_thickness</span> <span class="o">=</span> <span class="n">r_cmb</span> <span class="o">-</span> <span class="n">r_s_new</span>

            <span class="c1">#Regrid domain, keeping temperature relative to the adiabat.</span>
            <span class="n">T_rel</span> <span class="o">=</span> <span class="n">T_new</span><span class="p">[</span><span class="n">r</span><span class="o">&lt;</span><span class="n">r_fes</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">r</span><span class="o">&lt;</span><span class="n">r_fes</span><span class="p">],</span> <span class="n">Tcen</span><span class="p">,</span> <span class="n">core_adiabat</span><span class="p">)</span>

            <span class="n">r_prof_bulk</span><span class="p">,</span> <span class="n">T_rel</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">change_domain_size</span><span class="p">(</span><span class="n">T_rel</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="n">r</span><span class="o">&lt;</span><span class="n">r_fes</span><span class="p">],</span> <span class="n">r_s_new</span><span class="p">,</span> <span class="p">(</span><span class="n">resolution</span><span class="p">,</span><span class="n">min_res</span><span class="p">,</span><span class="n">max_res</span><span class="p">))</span>

            <span class="n">T_prof_bulk</span> <span class="o">=</span> <span class="n">T_rel</span> <span class="o">+</span> <span class="n">prof</span><span class="o">.</span><span class="n">adiabat</span><span class="p">(</span><span class="n">r_prof_bulk</span><span class="p">,</span> <span class="n">Tcen</span><span class="p">,</span> <span class="n">core_adiabat</span><span class="p">)</span>


            <span class="n">r</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_prof_bulk</span><span class="p">,</span> <span class="n">r_prof_fes</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T_prof_bulk</span><span class="p">,</span> <span class="n">T_new</span><span class="p">[</span><span class="n">r</span><span class="o">&gt;=</span><span class="n">r_fes</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">r_s_new</span> <span class="o">=</span> <span class="n">r_fes</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T_new</span>

        <span class="n">time_gone</span> <span class="o">+=</span> <span class="n">dt_small</span>
  


    <span class="c1">#Save new profiles. Keep original profiles until update() has been called.</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">_next_profiles</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">_next_profiles</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>

    <span class="c1">#!# Save separate bulk and FeS profiles.</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;bulk&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="n">r_prof_fes</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;bulk&#39;</span><span class="p">][</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="p">[:</span><span class="o">-</span><span class="n">r_prof_fes</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;fes&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="n">r_prof_fes</span><span class="o">.</span><span class="n">size</span><span class="p">:]</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="s1">&#39;fes&#39;</span><span class="p">][</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="n">r_prof_fes</span><span class="o">.</span><span class="n">size</span><span class="p">:]</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">ds_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_s_new</span> <span class="o">-</span> <span class="n">r_s_original</span><span class="p">)</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span>

    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sl</span><span class="o">.</span><span class="n">T_grad_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sl</span><span class="o">.</span><span class="n">T_grad_s</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">sl</span><span class="o">.</span><span class="n">lb_T</span> <span class="o">=</span> <span class="n">lb</span>
    <span class="n">sl</span><span class="o">.</span><span class="n">ub_T</span> <span class="o">=</span> <span class="n">ub</span></div>






















<span class="c1"># def setup(model):</span>
<span class="c1">#     &#39;&#39;&#39;Setup the initial stable layer</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     model : ThermalModel</span>
<span class="c1">#         Main model class</span>
<span class="c1">#     &#39;&#39;&#39;</span>

<span class="c1">#     prm = model.parameters</span>
<span class="c1">#     sl = model.stable_layer</span>
<span class="c1">#     core = model.core</span>

<span class="c1">#     sl.layer_thickness = prm.FeS_size</span>

<span class="c1">#     sl.layer_thickness = prm.layer_thickness</span>

<span class="c1">#     if not prm.core:</span>
<span class="c1">#         raise ValueError(&#39;Needs a core model&#39;)</span>

<span class="c1">#     #Initialise profiles dictionaries</span>
<span class="c1">#     sl.profiles = {}</span>
<span class="c1">#     sl._next_profiles = {}</span>

<span class="c1">#     n = prm.max_resolution</span>

<span class="c1">#     #Create radial profiles</span>
<span class="c1">#     sl.profiles[&#39;r&#39;] = linspace(core.rs, prm.r_cmb, n)</span>
<span class="c1">#     sl.profiles[&#39;T&#39;] = np.interp(sl.profiles[&#39;r&#39;], core.profiles[&#39;r&#39;], core.profiles[&#39;T&#39;])</span>

<span class="c1">#     # sl.profiles[&#39;T&#39;] = prof.adiabat(sl.profiles[&#39;r&#39;], core._Tcen_fes, prm.fes_adiabat_params) #FeS adiabat</span>
<span class="c1">#     sl.T_grad_s      = prof.adiabat_grad(core.rs, core.Tcen, prm.core_adiabat_params) #Bulk core adiabatic gradient at rs</span>

<span class="c1"># def evolve(model):</span>
<span class="c1">#     &#39;&#39;&#39;Evolve the stable layer</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     model : ThermalModel</span>
<span class="c1">#         Main model class</span>
<span class="c1">#     &#39;&#39;&#39;</span>

<span class="c1">#     sl = model.stable_layer</span>
<span class="c1">#     core = model.core</span>
<span class="c1">#     prm = model.parameters</span>

<span class="c1">#     sl.Q_cmb = model.mantle.Q_cmb</span>

<span class="c1">#     r_fes = prm.r_cmb - prm.FeS_size #radius of FeS layer</span>
<span class="c1">#     fes_idx = core._fes_idx          #Index for FeS layer in core profiles</span>


<span class="c1">#     #Initialise energies/entropies associated with this state.</span>
<span class="c1">#     Qs, Es, Ek, Ej = 0, 0, 0, 0</span>

<span class="c1">#     #initialise BC&#39;s</span>
<span class="c1">#     sl.lb_T, sl.ub_T = 0,0</span>
<span class="c1">#     sl.T_grad_s = 0</span>

<span class="c1">#     sl.alpha_D = 0</span>
<span class="c1">#     sl.baro_grad = 0</span>


<span class="c1">#     if sl.layer_thickness &gt; prm.FeS_size:</span>
<span class="c1">#         T_grad_fes = np.interp(r_fes, sl.profiles[&#39;r&#39;], np.gradient(sl.profiles[&#39;T&#39;], sl.profiles[&#39;r&#39;], edge_order=2))</span>
<span class="c1">#     else:</span>
<span class="c1">#         T_grad_fes = core.profiles[&#39;dTa_dr&#39;][core._fes_idx-1]</span>

<span class="c1">#     heat_in = 4*np.pi*r_fes**2 * core.profiles[&#39;k&#39;][core._fes_idx-1] * -T_grad_fes</span>

<span class="c1">#     #Check if FeS layer is sub-adiabatic</span>
<span class="c1">#     ADR_fes = (core.Q_cmb-heat_in)/core.Qa</span>
<span class="c1">#     ADR_fes = core.Q_cmb/core.Qa</span>

<span class="c1">#     FeS_convecting = True</span>
<span class="c1">#     if ADR_fes &lt; 1:</span>
<span class="c1">#         FeS_convecting = False</span>

<span class="c1">#     FeS_convecting = True #Force convecting FeS layer</span>

<span class="c1">#     #If no thermal stratification exists yet, re-set secular cooling of bulk.</span>
<span class="c1">#     if sl.layer_thickness == prm.FeS_size:</span>

<span class="c1">#         #Cooling rates in core calculation assumes adiabatic heat flow at rs, correct it here to account for</span>
<span class="c1">#         #secular cooling of FeS layer as well.</span>

<span class="c1">#         r, rho, T, cp = core.profiles[&#39;r&#39;], core.profiles[&#39;rho&#39;], core.profiles[&#39;T&#39;], core.profiles[&#39;cp&#39;]</span>
<span class="c1">#         Qs_tilde, Es_tilde = en.secular_cool(r, rho, T, cp, r.size, Tcmb=T[-1]) #Secular cooling of whole core (inc FeS layer)</span>
<span class="c1">#         Ql_tilde = core.Ql/core.dT_dt   #Re-normalise values</span>
<span class="c1">#         Qg_tilde = core.Qg/core.dT_dt</span>

<span class="c1">#         dT_dt = (core.Q_cmb-core.Qr)/(Qs_tilde+Ql_tilde+Qg_tilde)  #New corrected cooling rate of core</span>

<span class="c1">#         dT_dt_fes = dT_dt * core._Tcen_fes/core.Tcen  #FeS cooling rate</span>

<span class="c1">#         core.Q_fes = core.Q_cmb - dT_dt*(Qs_tilde - core.Qs/core.dT_dt) #Heat flow at base of FeS layer (Q_cmb minus secular cooling of FeS layer)</span>

<span class="c1">#         #Sub-adiabatic. reset Q_fes to Qa at r_fes and layer will start to grow.</span>
<span class="c1">#         if core.Q_fes &lt; core.Qa_rs:</span>

<span class="c1">#             # Q_fes = core.Qa_rs #Set to adiabatic heat flow.</span>
<span class="c1">#             dT_dt = core.dT_dt</span>

<span class="c1">#             # Qs_fes = core.Q_cmb-Q_fes</span>

<span class="c1">#             # dT_dt_fes = Qs_fes/Qs_tilde</span>


<span class="c1">#             # dT_dt = (core.Q_cmb-core.Qr)/(Qs_tilde+Ql_tilde+Qg_tilde)  #New corrected cooling rate of core</span>

<span class="c1">#         #New ADR_fes</span>
<span class="c1">#         ADR_fes = core.Q_cmb/core.Qa</span>

<span class="c1">#         profiles = core.profiles</span>
<span class="c1">#         r, T = profiles[&#39;r&#39;], profiles[&#39;T&#39;]</span>
<span class="c1">#         idx = core._fes_idx</span>
<span class="c1">#         Qs_tilde, Es_tilde = en.secular_cool(profiles[&#39;r&#39;][idx:], profiles[&#39;rho&#39;][idx:], profiles[&#39;T&#39;][idx:], profiles[&#39;cp&#39;][idx:], prm.n_profiles-idx) #Just FeS layer integrals</span>

<span class="c1">#         Qs_tilde = Qs_tilde * profiles[&#39;T&#39;][idx]/core._Tcen_fes #Renormalise from Tcen value to theoretical FeS adiabat at Tcen</span>
<span class="c1">#         Es_tilde = Es_tilde * profiles[&#39;T&#39;][idx]/core._Tcen_fes</span>

<span class="c1">#         sl.dT_dr_fes = profiles[&#39;dTa_dr&#39;][idx]</span>

        
            
<span class="c1">#         # if model.it == 1 and core.Q_fes &lt; core.Qa_rs:</span>

<span class="c1">#         #     sl.profiles[&#39;r&#39;] = linspace(0, r_fes, 60)</span>
<span class="c1">#         #     sl.profiles[&#39;T&#39;] = prof.adiabat(sl.profiles[&#39;r&#39;], core.Tcen, prm.core_adiabat_params)</span>
<span class="c1">#         #     sl.layer_thickness = prm.r_cmb</span>
<span class="c1">#         #     dT_dt = 0</span>


<span class="c1">#         Qs += Qs_tilde*dT_dt_fes    #Add secular cooling of just FeS layer to secular cooling of total layer.</span>
<span class="c1">#         Es += Es_tilde*dT_dt_fes</span>


<span class="c1">#         #Correct core energies/entropies</span>
<span class="c1">#         core.Qs = core.Qs*dT_dt/core.dT_dt</span>
<span class="c1">#         core.Ql = core.Ql*dT_dt/core.dT_dt</span>
<span class="c1">#         core.Qg = core.Qg*dT_dt/core.dT_dt</span>

<span class="c1">#         core.dri_dt = core.Cr*core.dT_dt</span>
<span class="c1">#         core.dc_dt  = core.Cr*core.Cc*core.dT_dt</span>

<span class="c1">#         core.Es = core.Es*dT_dt/core.dT_dt</span>
<span class="c1">#         core.El = core.El*dT_dt/core.dT_dt</span>
<span class="c1">#         core.Eg = core.Eg*dT_dt/core.dT_dt</span>

<span class="c1">#         core.Ej = core.Es + core.Eg + core.El - core.Ek - core.Ea</span>

<span class="c1">#         #Correct cooling rates</span>
<span class="c1">#         core.dT_dt = dT_dt</span>
<span class="c1">#         core._dT_dt_fes = dT_dt_fes</span>

<span class="c1">#     elif FeS_convecting:</span>

<span class="c1">#         #FeS layer is convecting</span>
        
<span class="c1">#         profiles = core.profiles</span>
<span class="c1">#         r, T = profiles[&#39;r&#39;], profiles[&#39;T&#39;]</span>
<span class="c1">#         idx = core._fes_idx</span>

<span class="c1">#         #FeS layer needs mixing as convection starts again. sl.ADR_fes is value from previous timestep.</span>
<span class="c1">#         if model.it &gt; 1 and (sl.ADR_fes &lt; 1 and ADR_fes &gt;= 1):</span>

<span class="c1">#             total_heat = trapezoid(r[idx:], r[idx:]**2 * T[idx:])[-1] #Conserve total thermal mass</span>

<span class="c1">#             core._Tcen_fes = total_heat / trapezoid(r[idx:], r[idx:]**2 * prof.adiabat(r[idx:], 1, prm.fes_adiabat_params))[-1]</span>

<span class="c1">#         #Normliased energies for convecting FeS layer</span>
<span class="c1">#         Qs_tilde, Es_tilde = en.secular_cool(profiles[&#39;r&#39;][idx:], profiles[&#39;rho&#39;][idx:], profiles[&#39;T&#39;][idx:], profiles[&#39;cp&#39;][idx:], prm.n_profiles-idx) #Just FeS layer integrals</span>
<span class="c1">#         Qs_tilde *= profiles[&#39;T&#39;][idx]/core._Tcen_fes #Renormalise from Tcen value to theoretical FeS adiabat at Tcen</span>

<span class="c1">#         # breakpoint()</span>
<span class="c1">#         # core.Q_fes = (core.Qs + core.Qg + core.Ql) + sl._Qs_strat</span>

<span class="c1">#         # core.Q_fes = core.Q_cmb #TEST</span>

<span class="c1">#         # #Heat flow into base of FeS layer</span>
<span class="c1">#         # T_grad_fes = np.interp(r_fes, sl.profiles[&#39;r&#39;], np.gradient(sl.profiles[&#39;T&#39;], sl.profiles[&#39;r&#39;], edge_order=2))</span>
<span class="c1">#         T_grad_fes = (T[idx-1]-T[idx-2])/(r[idx-1]-r[idx-2])</span>
<span class="c1">#         core.Q_fes = 4*np.pi*r_fes**2 * profiles[&#39;k&#39;][idx-1] * -T_grad_fes</span>

<span class="c1">#         core._dT_dt_fes = (core.Q_cmb - core.Q_fes)/Qs_tilde</span>

<span class="c1">#         sl.Qs_fes = Qs_tilde*core._dT_dt_fes</span>

<span class="c1">#         # if model.it &gt;= 7574:</span>
<span class="c1">#         #     print(core._Tcen_fes, core._dT_dt_fes, prof.adiabat(prm.r_cmb, core._Tcen_fes, prm.fes_adiabat_params))</span>
<span class="c1">#         #     breakpoint()</span>

<span class="c1">#     else:</span>
<span class="c1">#         #Secular cooling of FeS layer will be accounted for in conduction solution.</span>

<span class="c1">#         profiles = core.profiles</span>
<span class="c1">#         r, T = profiles[&#39;r&#39;], profiles[&#39;T&#39;]</span>
<span class="c1">#         idx = core._fes_idx</span>

<span class="c1">#         #Set theoretical Tcen to track the temperature at r_fes</span>
<span class="c1">#         core._Tcen_fes = T[idx] / prof.adiabat(r[idx], 1, prm.fes_adiabat_params)</span>
        


<span class="c1">#     sl.ADR_fes = ADR_fes</span>
<span class="c1">#     # sl.ADR_fes = 1.1 #Force adiabatic FeS layer for now</span>


<span class="c1">#     #Check if bulk core is adiabatic</span>
<span class="c1">#     ADR = core.Q_fes/core.Qa_fes</span>
<span class="c1">#     sl.ADR = ADR</span>

<span class="c1">#     #Estimate based on Qc rather than Q_fes</span>
<span class="c1">#     sl.ADR = core.Q_cmb / (-4*np.pi*prm.r_cmb**2 * profiles[&#39;k&#39;][core._fes_idx-1] * prof.adiabat_grad(prm.r_cmb, core.Tcen, prm.core_adiabat_params))</span>

<span class="c1">#     #Profiles before diffusion solution.</span>
<span class="c1">#     r_initial = sl.profiles[&#39;r&#39;]</span>
<span class="c1">#     T_initial = sl.profiles[&#39;T&#39;]</span>

<span class="c1">#     #Calculate Ek</span>
<span class="c1">#     dT_dr = np.gradient(T_initial, r_initial, edge_order=2)</span>
<span class="c1">#     k = np.interp(r_initial, core.profiles[&#39;r&#39;], core.profiles[&#39;k&#39;])</span>
<span class="c1">#     Ek = 4*np.pi*trapz(k*(dT_dr/T_initial)**2*r_initial**2, x=r_initial)</span>

<span class="c1">#     #If no layer exists and bulk is super-adiabatic, don&#39;t bother with diffusion solution.</span>
<span class="c1">#     if sl.ADR &gt;= 1 and sl.layer_thickness == prm.FeS_size:</span>
<span class="c1">#         sl._next_profiles[&#39;r&#39;] = np.linspace(r_fes, prm.r_cmb, 10)</span>
<span class="c1">#         sl._next_profiles[&#39;T&#39;] = prof.adiabat(sl._next_profiles[&#39;r&#39;], core._Tcen_fes + model.dt*core._dT_dt_fes, prm.fes_adiabat_params) # np.full(10, core.Tcen + model.dt*core.dT_dt)</span>
<span class="c1">#         sl.ds_dt = 0</span>
<span class="c1">#     else:</span>
<span class="c1">#         #Time step layer evolution</span>
<span class="c1">#         pure_thermal_method(model)</span>

<span class="c1">#     #New radial profiles</span>
<span class="c1">#     r_new = sl._next_profiles[&#39;r&#39;]</span>
<span class="c1">#     T_new = sl._next_profiles[&#39;T&#39;]</span>


<span class="c1">#     #Secular cooling. Compare final profiles to those at the beginning of the time-step.</span>
<span class="c1">#     if r_new[0] &lt;= r_initial[0]:  #Layer has grown</span>

<span class="c1">#         #Need to append adiabat values onto initial temperatures</span>
<span class="c1">#         T_initial_temp = prof.adiabat(r_new, core.Tcen, prm.core_adiabat_params)</span>

<span class="c1">#         for i in range(r_new.size):</span>
<span class="c1">#             if r_new[i] &gt;= r_initial[0]:</span>
<span class="c1">#                 T_initial_temp[i] = np.interp(r_new[i], r_initial, T_initial)</span>
<span class="c1">#         T_initial = T_initial_temp</span>

<span class="c1">#         r1, T2, T1 = r_new, T_new, T_initial</span>

<span class="c1">#     elif r_new[0] &gt; r_initial[0]:  #Layer has shrunk</span>

<span class="c1">#         #Need to append on adiabatic values onto new temperature</span>
<span class="c1">#         T_new_temp = prof.adiabat(r_initial, core.Tcen + core.dT_dt*model.dt, prm.core_adiabat_params)</span>

<span class="c1">#         for i in range(r_initial.size):</span>
<span class="c1">#             if r_initial[i] &gt;= r_new[0]:</span>
<span class="c1">#                 T_new_temp[i] = np.interp(r_initial[i], r_new, T_new)</span>

<span class="c1">#         T_new = T_new_temp</span>

<span class="c1">#         r1, T2, T1 = r_initial, T_new, T_initial</span>

<span class="c1">#     dT_dt = (T2-T1)/model.dt</span>


<span class="c1">#     cp  = np.interp(r1, core.profiles[&#39;r&#39;], core.profiles[&#39;cp&#39;])</span>
<span class="c1">#     rho = np.interp(r1, core.profiles[&#39;r&#39;], core.profiles[&#39;rho&#39;])</span>
<span class="c1">#     Qs += -4*np.pi*en.integrate(r1, r1**2*dT_dt*rho*cp)</span>
<span class="c1">#     Es += -4*np.pi*en.integrate(r1, r1**2*dT_dt*rho*cp*(1/T1[-1] - 1/T1))</span>
<span class="c1">#     sl.dT_dt_s = dT_dt[0]  #Save cooling rate at base of layer</span>

<span class="c1">#     # if core.ri &gt; 0:</span>
<span class="c1">#     #     breakpoint()</span>


<span class="c1">#     # breakpoint()</span>

<span class="c1">#     Ej = Es - Ek</span>

<span class="c1">#     #Save energies/entropies to model attributes</span>
<span class="c1">#     sl.Qs, sl.Es, sl.Ek, sl.Ej = Qs, Es, Ek, Ej</span>

<span class="c1">#     # if sl.layer_thickness &gt; prm.FeS_size:</span>
<span class="c1">#     #     breakpoint()</span>

<span class="c1">#     #Save secular cooling of stratified fluid for next iteration for calculating Q_fes.</span>
<span class="c1">#     if r_new[0] &lt; r_fes:</span>
<span class="c1">#         sl._Qs_strat = -4*np.pi*en.integrate(r1[r1&lt;=r_fes], r1[r1&lt;=r_fes]**2 * dT_dt[r1&lt;=r_fes] * rho[r1&lt;=r_fes] * cp[r1&lt;=r_fes]) #Secular cooling of stratified fluid not in FeS layer</span>

<span class="c1">#     #Add onto core results</span>
<span class="c1">#     if prm.core:</span>
<span class="c1">#         core.Qs += Qs</span>
<span class="c1">#         core.Ej += Ej</span>
<span class="c1">#         core.Es += Es</span>
<span class="c1">#         core.Ek += Ek</span>

<span class="c1">#         # if r_new[0] &lt;= r_fes and ADR_fes &gt;=1: #Convecting FeS layer secular cooling</span>

<span class="c1">#         #     profiles = core.profiles</span>
<span class="c1">#         #     r, T = profiles[&#39;r&#39;], profiles[&#39;T&#39;]</span>

<span class="c1">#         #     idx = core._fes_idx</span>

<span class="c1">#         #     #Temp gradient at r_fes</span>
<span class="c1">#         #     dT_dr_fes = (T[idx-1]-T[idx-2])/(r[idx-1]-r[idx-2])</span>

<span class="c1">#         #     #Conductive heat flow from bulk into FeS layer.</span>
<span class="c1">#         #     core.Q_fes = -profiles[&#39;k&#39;][idx-1]*dT_dr_fes*4*np.pi*r_fes**2</span>

<span class="c1">#         #     Qs_fes = core.Q_cmb-core.Q_fes</span>

<span class="c1">#         #     Qs_tilde, Es_tilde = en.secular_cool(profiles[&#39;r&#39;][idx:], profiles[&#39;rho&#39;][idx:], profiles[&#39;T&#39;][idx:], profiles[&#39;cp&#39;][idx:], prm.n_profiles-idx)</span>
<span class="c1">#         #     Qs_tilde = Qs_tilde * profiles[&#39;T&#39;][idx]/core._Tcen_fes</span>
<span class="c1">#         #     Es_tilde = Es_tilde * profiles[&#39;T&#39;][idx]/core._Tcen_fes #Renormalise from first T value to theoretical FeS adiabat at Tcen</span>
<span class="c1">#         #     dT_dt_fes = Qs_fes/Qs_tilde</span>

<span class="c1">#         #     #Add on energy and entropy for FeS layer</span>
<span class="c1">#         #     core.Qs += Qs_fes</span>
<span class="c1">#         #     core.Es += Es_tilde*dT_dt_fes</span>
<span class="c1">#         #     core._dT_dt_fes = dT_dt_fes</span>

<span class="c1">#     #Make sure profiles have size maximum_resolution, so they can be saved.</span>
<span class="c1">#     n = sl.profiles[&#39;r&#39;].size</span>

<span class="c1">#     if n &gt; prm.max_resolution:</span>

<span class="c1">#         r = linspace(sl.profiles[&#39;r&#39;][0], sl.profiles[&#39;r&#39;][-1], prm.max_resolution)</span>
<span class="c1">#         T = np.interp(r, sl.profiles[&#39;r&#39;], sl.profiles[&#39;T&#39;])</span>

<span class="c1">#     elif n &lt; prm.max_resolution:</span>

<span class="c1">#         r = np.append(sl.profiles[&#39;r&#39;], np.ones(prm.max_resolution-n)*sl.profiles[&#39;r&#39;][-1])</span>
<span class="c1">#         T = np.append(sl.profiles[&#39;T&#39;], np.ones(prm.max_resolution-n)*sl.profiles[&#39;T&#39;][-1])</span>

<span class="c1">#     else:</span>
<span class="c1">#         r, T = sl.profiles[&#39;r&#39;], sl.profiles[&#39;T&#39;]</span>


<span class="c1">#     sl.profiles[&#39;r&#39;], sl.profiles[&#39;T&#39;] = r, T</span>

<span class="c1">#     sl.profiles[&#39;Ta&#39;] = prof.adiabat(r, core.Tcen, prm.core_adiabat_params)</span>

<span class="c1">#     sl.T_cmb, sl.T_s= T[-1], T[0]</span>

<span class="c1">#     core.T_cmb,  core.T_s = sl.T_cmb, sl.T_s</span>

<span class="c1">#     if prm.FeS_size == 0:</span>
<span class="c1">#         core._Tcen_fes = core.Tcen</span>
<span class="c1">#         core._dT_dt_fes = core._dT_dt_fes</span>



<span class="c1"># def update(model):</span>
<span class="c1">#     &#39;&#39;&#39;Update function</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     model : ThermalModel</span>
<span class="c1">#         Main model class</span>
<span class="c1">#     &#39;&#39;&#39;</span>

<span class="c1">#     sl = model.stable_layer</span>
<span class="c1">#     prm = model.parameters</span>

<span class="c1">#     #Update profiles</span>
<span class="c1">#     sl.profiles = sl._next_profiles.copy()</span>
<span class="c1">#     sl.profiles[&#39;Ta&#39;] = prof.adiabat(sl.profiles[&#39;r&#39;], model.core.Tcen, prm.core_adiabat_params)</span>

<span class="c1">#     #Update core profiles if no core model is being used.</span>
<span class="c1">#     if not prm.core:</span>
<span class="c1">#         prof.basic_profiles(model)</span>

<span class="c1">#     #Update layer size</span>
<span class="c1">#     sl.layer_thickness -= sl.ds_dt * model.dt</span>
<span class="c1">#     if sl.layer_thickness &lt; 0:</span>
<span class="c1">#         sl.layer_thickness = 0</span>

<span class="c1">#     model.core.rs = prm.r_cmb - sl.layer_thickness</span>
<span class="c1">#     model.core.T_cmb = sl.profiles[&#39;T&#39;][-1]</span>

<span class="c1">#     #If layer covers entire core, Tcen is temp at base of layer.</span>
<span class="c1">#     if sl.layer_thickness == prm.r_cmb:</span>
<span class="c1">#         model.core.Tcen = sl.profiles[&#39;T&#39;][0]</span>
<span class="c1">#         model.core.dT_dt = sl.dT_dt_s</span>

<span class="c1">#     #Track theoretical Tcen for fes layer if it is part of the conduction solution.</span>
<span class="c1">#     if sl.ADR_fes &lt; 1:</span>
<span class="c1">#         model.core._Tcen_fes = model.core.T_cmb / prof.adiabat(prm.r_cmb, 1, prm.fes_adiabat_params)</span>






<span class="c1"># def progress(model):</span>
<span class="c1">#     &#39;&#39;&#39;text to display during calculation</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     model : ThermalModel</span>
<span class="c1">#         Main model class</span>

<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     str</span>
<span class="c1">#         text to display to STDOUT</span>
<span class="c1">#     &#39;&#39;&#39;</span>

<span class="c1">#     sl = model.stable_layer</span>

<span class="c1">#     v = (sl.layer_thickness/1000, sl.Q_cmb/1e12, sl.ADR, sl.T_cmb)</span>

<span class="c1">#     text = f&#39;    layer thickness: {v[0]:.2f} km    Q_cmb: {v[1]:.2f} TW    ADR(rc): {v[2]:.2f}    T_cmb: {v[3]:.2f} K&#39;</span>

<span class="c1">#     return text</span>





<span class="c1"># def pure_thermal_method(model):</span>
<span class="c1">#     &#39;&#39;&#39;Pure thermal stratification</span>

<span class="c1">#     Solves the thermal diffusion solution and updates the layer size during one time iteration.</span>
<span class="c1">#     For stability, it may step in smaller time increments until the total model timestep has been</span>
<span class="c1">#     reached.</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     model : ThermalModel</span>
<span class="c1">#         Main model class</span>

<span class="c1">#     &#39;&#39;&#39;</span>

<span class="c1">#     core = model.core</span>
<span class="c1">#     sl  = model.stable_layer</span>
<span class="c1">#     prm = model.parameters</span>

<span class="c1">#     #Read in values from model</span>
<span class="c1">#     layer_thickness = sl.layer_thickness</span>
<span class="c1">#     r_s = prm.r_cmb - layer_thickness</span>
<span class="c1">#     r_s_original = r_s*1</span>

<span class="c1">#     r_cmb      = prm.r_cmb</span>
<span class="c1">#     resolution = prm.resolution</span>
<span class="c1">#     min_res    = prm.min_resolution</span>
<span class="c1">#     max_res    = prm.max_resolution</span>

<span class="c1">#     TOL = prm.depth_tolerance   #Minimum layer size</span>
<span class="c1">#     init_size = prm.init_size + prm.FeS_size</span>

<span class="c1">#     core_adiabat      = prm.core_adiabat_params</span>
<span class="c1">#     rho_poly          = prm.core_liquid_density_params</span>

<span class="c1">#     E_T = prm.entrainment_T</span>

<span class="c1">#     #Heat flows</span>
<span class="c1">#     Q_cmb  = model.mantle.Q_cmb</span>
<span class="c1">#     Q_fes = core.Q_fes</span>

<span class="c1">#     Tcen   = model.core.Tcen</span>
<span class="c1">#     dTa_dt = model.core.dT_dt</span>

<span class="c1">#     #Base of FeS layer</span>
<span class="c1">#     r_fes = prm.r_cmb - prm.FeS_size</span>

<span class="c1">#     #Existing radial profiles</span>
<span class="c1">#     r = sl.profiles[&#39;r&#39;]</span>
<span class="c1">#     T = sl.profiles[&#39;T&#39;]</span>

<span class="c1">#     #Set upper boundary conditions</span>
<span class="c1">#     #If FeS layer is sub-adiabatic, solution as normal</span>
<span class="c1">#     ub = prof.adiabat_grad(prm.r_cmb, core._Tcen_fes, prm.fes_adiabat_params)*sl.ADR_fes</span>
<span class="c1">#     ub = core.Q_cmb/(4*np.pi*prm.r_cmb**2*-core.profiles[&#39;k&#39;][-1])</span>
<span class="c1">#     ub_type = 1</span>

<span class="c1">#     # if sl.ADR_fes &gt;= 1:</span>
<span class="c1">#     #     sl.ADR_fes = 0.99</span>

<span class="c1">#     if sl.ADR_fes &gt;= 1:</span>
<span class="c1">#         r_upper = r_fes</span>

<span class="c1">#     r_upper = r_fes #Force convecting FeS layer for now.</span>


<span class="c1">#     #For stability, reduce the time step size when layer is relatively thin.</span>
<span class="c1">#     factor = 1</span>
<span class="c1">#     # if layer_thickness &lt;= init_size*3:</span>
<span class="c1">#     #     factor = 0.01</span>

<span class="c1">#     time_gone = 0</span>
<span class="c1">#     while time_gone &lt; model.dt:</span>

<span class="c1">#         coarse = prm.coarse_resolution</span>
<span class="c1">#         fine   = prm.fine_resolution</span>

<span class="c1">#         #Initialise layer with minium tolerance thickness</span>
<span class="c1">#         if layer_thickness &lt; TOL + prm.FeS_size:</span>

<span class="c1">#             layer_thickness = init_size</span>

<span class="c1">#             #Number of grid points in this iteration</span>
<span class="c1">#             n_points = int(np.max([min_res,layer_thickness*resolution]))</span>
<span class="c1">#             n_points = int(np.min([max_res,n_points]))</span>

<span class="c1">#             r_s = prm.r_cmb - layer_thickness</span>

<span class="c1">#             # r_test = np.linspace(r_s, r_upper, n_points)</span>
            

<span class="c1">#             r = adaptive_grid(r_s, r_fes, r_upper, coarse, fine, transition_width=200e3)</span>

<span class="c1">#             T = prof.adiabat(r, Tcen, core_adiabat)</span>
<span class="c1">#             # T_test = prof.adiabat(r_test, Tcen, core_adiabat)</span>

<span class="c1">#         elif r_upper == r_fes:</span>
<span class="c1">#             #FeS layer is still convecting so just solve for bulk core that is thermally stratified.</span>

<span class="c1">#             #Number of grid points in this iteration</span>
<span class="c1">#             n_points = int(np.max([min_res,int((r_upper-r_s)/coarse)]))</span>
<span class="c1">#             n_points = int(np.min([max_res,n_points]))</span>

<span class="c1">#             r_s = prm.r_cmb - layer_thickness</span>

<span class="c1">#             # coarse = np.min([10e3, (r_upper-r_s)/10])</span>
<span class="c1">#             # fine = np.min([2e3, (r_upper-r_s)/20])</span>
<span class="c1">#             r = np.linspace(r_s, r_upper, n_points)</span>
<span class="c1">#             # r = adaptive_grid(r_s, r_fes, r_upper, coarse, fine, transition_width=200e3)</span>

<span class="c1">#             T = np.interp(r, sl.profiles[&#39;r&#39;], sl.profiles[&#39;T&#39;])</span>

<span class="c1">#         else:</span>
<span class="c1">#             #Make sure solution is on even grid</span>
<span class="c1">#             n_points = int(np.max([min_res,layer_thickness*resolution]))</span>
<span class="c1">#             n_points = int(np.min([max_res,n_points]))</span>

<span class="c1">#             # coarse = np.min([10e3, (r_upper-r_s)/10])</span>
<span class="c1">#             # fine = np.min([2e3, (r_upper-r_s)/20])</span>

<span class="c1">#             r = adaptive_grid(r_s, r_fes, r_upper, coarse, fine, transition_width=200e3)</span>
<span class="c1">#             # r = np.linspace(sl.profiles[&#39;r&#39;][0], sl.profiles[&#39;r&#39;][-1], n_points)</span>
<span class="c1">#             T = np.interp(r, sl.profiles[&#39;r&#39;], sl.profiles[&#39;T&#39;])</span>

<span class="c1">#             # breakpoint()</span>


<span class="c1">#         dt_small = model.dt*factor</span>

<span class="c1">#         if time_gone + dt_small &gt; model.dt:</span>
<span class="c1">#             dt_small = model.dt - time_gone</span>

<span class="c1">#         #Regrid core radial profiles onto finer stable layer grid</span>
<span class="c1">#         rho = prof.density(r, rho_poly)</span>

<span class="c1">#         #n = int((r.size-1)*(layer_thickness-prm.FeS_layer_size)/layer_thickness)</span>

<span class="c1">#         # FeS_idx = np.where(r &gt;= prm.r_cmb-prm.FeS_layer_size)[0][0]</span>
<span class="c1">#         # if FeS_idx &gt;= r.size-2:</span>
<span class="c1">#         #     breakpoint()</span>
<span class="c1">#         # k, dk_dr = tanh_conductivity(r, core.profiles[&#39;k&#39;][0], prm.FeS_conductivity, FeS_idx)</span>


<span class="c1">#         if r_upper == prm.r_cmb:</span>
<span class="c1">#             k, dk_dr = tanh_conductivity(r, core.profiles[&#39;k&#39;][0], prm.core_fes_conductivity, r_fes, transition_width=5000)</span>
<span class="c1">#         else:</span>
<span class="c1">#             k = core.profiles[&#39;k&#39;]</span>
<span class="c1">#             dk_dr = np.zeros(k.size)</span>

<span class="c1">#             k   = np.interp(r, core.profiles[&#39;r&#39;], k)</span>
<span class="c1">#             dk_dr = np.interp(r, core.profiles[&#39;r&#39;], dk_dr)</span>

<span class="c1">#             # k_test = np.full(r_test.size, k[0])</span>
<span class="c1">#             # dk_dr_test = np.zeros(r_test.size)</span>



<span class="c1">#         # if layer_thickness &gt; prm.FeS_layer_size:</span>
<span class="c1">#         #     breakpoint()</span>

<span class="c1">#         cp    = np.interp(r, core.profiles[&#39;r&#39;], core.profiles[&#39;cp&#39;])</span>
<span class="c1">#         alpha = np.interp(r, core.profiles[&#39;r&#39;], core.profiles[&#39;alpha&#39;])</span>

<span class="c1">#         #Thermal diffusivity</span>
<span class="c1">#         D_T = k/(rho*cp)</span>
<span class="c1">#         #dk_dr * 1/(rho*cp). Not the same as the diffusivity gradient</span>

<span class="c1">#         # D_T_test = np.full(r_test.size, D_T[0])</span>

<span class="c1">#         # dD_dr = np.gradient(k, r, edge_order=2)/(rho*cp)</span>
<span class="c1">#         dD_dr = dk_dr/(rho*cp)</span>


<span class="c1">#         #Cool adiabat</span>
<span class="c1">#         Tcen = core.Tcen + dTa_dt*(time_gone+dt_small)</span>
<span class="c1">#         Tcen_fes = core._Tcen_fes + core._dT_dt_fes*(time_gone+dt_small)</span>

<span class="c1">#         Ta, Ta_grad = prof.adiabat(r, Tcen, core_adiabat), prof.adiabat_grad(r, Tcen, core_adiabat)</span>

<span class="c1">#         Ta[r&gt;r_fes] = prof.adiabat(r[r&gt;r_fes], Tcen_fes, prm.fes_adiabat_params)</span>


<span class="c1">#         #Lower boundary condition (using entrainment)</span>
<span class="c1">#         lb = (1-E_T)*Ta_grad[0]</span>
<span class="c1">#         lb_type = 1</span>

<span class="c1">#         #Fes layer is convecting so change upper BC.</span>
<span class="c1">#         if r_upper == r_fes:</span>
<span class="c1">#             #Fixed temperature boundary condition</span>
<span class="c1">#             ub      = prof.adiabat(r_fes, Tcen_fes, prm.fes_adiabat_params)</span>
<span class="c1">#             ub_type = 0</span>

<span class="c1">#         #If whole core is stratified, lower BC should be zero flux</span>
<span class="c1">#         if r[0] == 0:</span>
<span class="c1">#             lb = 0</span>
   

<span class="c1">#         #Calculate diffusion solution</span>
<span class="c1">#         T_new = diffusion2(T, r, dt_small, D_T, k, dk_dr, (lb_type,lb),(ub_type,ub))</span>
<span class="c1">#         # T_new_test = diffusion(T_test, r_test, dt_small, D_T_test, k_test, dk_dr_test, (lb_type,lb),(ub_type,ub))</span>

<span class="c1">#         Qs = -4*np.pi*trapezoid(r, r**2 * rho* cp *(T_new-T)/dt_small)[-1]</span>
<span class="c1">#         # print(f&#39;Qs: {Qs: .3e}   Q_fes: {core.Q_fes-core.Qs: .3e}&#39;)</span>

<span class="c1">#         # print(model.it, t2-t1, np.min(np.diff(r)))</span>
<span class="c1">#         # if model.it &gt; 75 and ub_type == 1:</span>

<span class="c1">#         #     Q_top = 4*np.pi*r_cmb**2 * k[-1] * -ub</span>
<span class="c1">#         #     Q_bottom = 4*np.pi*rs**2 * k[0] * -lb</span>

<span class="c1">#         #     Qs = </span>
        
<span class="c1">#         # if core.ri&gt;0:</span>
<span class="c1">#         #     import matplotlib.pyplot as plt</span>
<span class="c1">#         #     plt.plot(r, T_new, label=&#39;T_new&#39;)</span>
<span class="c1">#         #     plt.plot(r, T, label=&#39;T&#39;)</span>
<span class="c1">#         #     plt.plot(r, Ta, label=&#39;Ta&#39;)</span>
<span class="c1">#         #     plt.legend(loc=0)</span>
<span class="c1">#         #     plt.savefig(&#39;test.png&#39;)</span>
<span class="c1">#         #     breakpoint()</span>



<span class="c1">#         #Set adiabat to track diffusion solution</span>
<span class="c1">#         if r[0] == 0:</span>
<span class="c1">#             Tcen = T_new[0]</span>
<span class="c1">#             Ta, Ta_grad = prof.adiabat(r, Tcen-100, core_adiabat), prof.adiabat_grad(r, Tcen, core_adiabat)</span>


<span class="c1">#         if np.isnan(T_new[0]):</span>
<span class="c1">#             breakpoint()</span>


<span class="c1">#         #Mix layer (experimental function, not used by default)</span>
<span class="c1">#         if prm.mix_layer:</span>
<span class="c1">#             T_rel = func.mix_profile(r, cp*rho*r**2, T_new-Ta)</span>
<span class="c1">#             T_new = T_rel + Ta</span>

<span class="c1">#         if sl.ADR &lt; 1 and r[0]==0:</span>
<span class="c1">#             r_s_new = 0</span>
<span class="c1">#         elif r[0] == 0 and model.it == 1:</span>
<span class="c1">#             r_s_new = 0</span>
<span class="c1">#         else:</span>
<span class="c1">#             #Determine if layer should retreat</span>
<span class="c1">#             r_s_new = func.retreat_layer(r[r&lt;=r_fes], T_new[r&lt;=r_fes], np.zeros(r.size)[r&lt;=r_fes], Ta[r&lt;=r_fes], 0, alpha[r&lt;=r_fes], 0, density_grad_limit=1e-6)</span>

<span class="c1">#         # print(f&#39;it: {model.it}   Qs: {core.Qs/1e12: .3f}   Qa: {core.Qa_rs/1e12: .3f}   size: {sl.layer_thickness/1000}    dT_dt_fes:{core._dT_dt_fes: .3e}&#39;)</span>

<span class="c1">#         #If whole core is stratified, only ADR&gt;=1 can change the layer thickness.</span>
<span class="c1">#         if r[0] == 0 and sl.ADR &lt; 1:</span>
<span class="c1">#             r_s_new = 0</span>

<span class="c1">#         #Grow layer</span>
<span class="c1">#         elif r_s_new == r[0]:</span>

<span class="c1">#             #Find radius on adiabat that matches temperature at base of layer</span>
<span class="c1">#             def f(guess,T,Tcen):</span>
<span class="c1">#                 return T - prof.adiabat(guess,Tcen,core_adiabat)</span>

<span class="c1">#             if T_new[0] &gt;= Tcen: #Layer has reached center of core</span>
<span class="c1">#                 r_s_new = 0</span>
<span class="c1">#             else:</span>
<span class="c1">#                 r_s_new = bisect(f,0,r_upper,args=(T_new[0],Tcen),maxiter=200)</span>

<span class="c1">#         #Shrink layer</span>
<span class="c1">#         else:</span>
<span class="c1">#             # import matplotlib.pyplot as plt</span>
<span class="c1">#             # plt.plot(r, T_new, label=&#39;T_new&#39;)</span>
<span class="c1">#             # plt.plot(r, T, label=&#39;T&#39;)</span>
<span class="c1">#             # plt.plot(r, Ta, label=&#39;Ta&#39;)</span>
<span class="c1">#             # plt.legend(loc=0)</span>
<span class="c1">#             # plt.show()</span>
<span class="c1">#             # breakpoint()</span>

<span class="c1">#             # # plt.savefig(&#39;test.png&#39;)</span>
<span class="c1">#             # breakpoint()</span>

<span class="c1">#             if r_s_new &gt;= r_upper-TOL:</span>

<span class="c1">#                 #No stratification. Try a larger timestep.</span>
<span class="c1">#                 r_s_new = r_upper</span>
<span class="c1">#                 factor = factor*2</span>

<span class="c1">#                 if factor &gt; 64 or sl.ADR &gt;= 1: #Give up is large time step doesn&#39;t help or core is super-adiabatic.</span>
<span class="c1">#                     dt_small = model.dt - time_gone</span>
<span class="c1">#                     factor = 1</span>

<span class="c1">#         #r_s must be include FeS layer.</span>
<span class="c1">#         # r_s_new = np.min([r_s_new, prm.r_cmb-prm.FeS_layer_size])</span>
        
<span class="c1">#         #If FeS layer is sub-adiabatic, r_s is at least at base of FeS layer.</span>
<span class="c1">#         if sl.ADR_fes &lt; 1:</span>
<span class="c1">#             r_s_new = np.min([r_fes, r_s_new])</span>


<span class="c1">#         layer_thickness = r_upper - r_s_new</span>

<span class="c1">#         #Regrid domain, keeping temperature relative to the adiabat.</span>
<span class="c1">#         T_rel = T_new - prof.adiabat(r, Tcen, core_adiabat)</span>

<span class="c1">#         r, T_rel = func.change_domain_size(T_rel, r, r_s_new, (resolution,min_res,max_res))</span>

<span class="c1">#         T = T_rel + prof.adiabat(r, Tcen, core_adiabat)</span>

<span class="c1">#         time_gone += dt_small</span>

<span class="c1">#     if r_upper &lt; r_cmb:</span>
<span class="c1">#         #Append values in the FeS layer</span>
<span class="c1">#         r = np.append(r, np.linspace(r_upper, prm.r_cmb,10)[1:])</span>
<span class="c1">#         T = np.append(T, prof.adiabat(r[-9:], Tcen_fes, prm.fes_adiabat_params))</span>

<span class="c1">#     #No layer this iteration</span>
<span class="c1">#     if r_s_new == r_upper:</span>
<span class="c1">#         layer_thickness = prm.FeS_size</span>
<span class="c1">#         r_s_new = r_fes</span>
<span class="c1">#         r, T = r[:9], T[:9]</span>

<span class="c1">#     #Save new profiles. Keep original profiles until update() has been called.</span>
<span class="c1">#     sl._next_profiles[&#39;r&#39;] = r</span>
<span class="c1">#     sl._next_profiles[&#39;T&#39;] = T</span>

<span class="c1">#     sl.ds_dt = (r_s_new - r_s_original)/model.dt</span>

<span class="c1">#     if r[1]-r[0] &gt; 0:</span>
<span class="c1">#         sl.T_grad_s = (T[1]-T[0])/(r[1]-r[0])</span>
<span class="c1">#     else:</span>
<span class="c1">#         sl.T_grad_s = 0</span>

<span class="c1">#     sl.lb_T = lb</span>
<span class="c1">#     sl.ub_T = ub</span>



<span class="c1">#Overwrite existing conductivity function with this one to set a conductivity anomaly at the top of the core.</span>
<span class="c1">#Fes layer size must be included in conductivity params.</span>

<span class="c1"># def conductivity_FeS(r, P, T, conductivity_params):</span>
    
<span class="c1">#     if len(conductivity_params)==1:</span>
<span class="c1">#         k = np.ones(r.size)*conductivity_params[0]</span>
    
<span class="c1">#     else:</span>

<span class="c1">#         k = np.ones(r.size)*conductivity_params[0]</span>

<span class="c1">#         k[r&gt;conductivity_params[1]] = conductivity_params[2]</span>

<span class="c1">#     return k</span>

<span class="c1"># prof.conductivity = conductivity_FeS</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, Sam Greenwood

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>